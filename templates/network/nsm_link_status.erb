#!/usr/bin/bash
#
# /usr/sbin/nsm_link_status
#
# Generated by Chef for <%= node[:fqdn] %>
#
 
# Relies on ifstat and bc
 
SENSORNAME=$1
IFACE=$2;
 
if [[ $(/usr/sbin/ethtool $IFACE 2> /dev/null | /usr/bin/egrep 'Link detected: yes') ]]; then
  KBPS=$(($(/usr/bin/ifstat -w -i $IFACE 1 1 | /usr/bin/tail -1 | /usr/bin/cut -d '.' -f1) * 8))
  GBPS=$(/usr/bin/echo "scale=3; $KBPS/1000/1000" | /usr/bin/bc)
  /usr/bin/echo "$(/usr/bin/date +'%Y-%m-%dT%H:%M:%S%z') hostname=$(/usr/bin/hostname) sensorname=$SENSORNAME nic=$IFACE state=UP kbps=$KBPS mbps=$(($KBPS/1000)) gbps=$GBPS";
else
  /usr/bin/echo "$(/usr/bin/date +'%Y-%m-%dT%H:%M:%S%z') hostname=$(/usr/bin/hostname) sensorname=$SENSORNAME nic=$IFACE state=DOWN kbps=0 mbps=0 gbps=0";
fi
 
