#
# /opt/zeek/share/zeek/site/<%= @local_zkg[:name] %>/<%= @local_zkg[:name] %>.zeek
#
# Generated by Chef for <%= node[:fqdn] %>


########################
# Extractions
########################

<% if @local_zkg[:mimetypes] %>
global ext_map: table[string] of string = {
    <% @local_zkg[:mimetypes].each do |mimetype, extension| %>
    ["<%= mimetype %>"] = "<%= extension %>",
    <% end %>
} &default ="";

event file_sniff(f: fa_file, meta: fa_metadata)
    {
    if ( ! meta?$mime_type || ext_map[meta$mime_type] == "" || f$source == "SMB")
        return;

    local ext = "";

    if ( meta?$mime_type )
        ext = ext_map[meta$mime_type];

    local fname = fmt("/nsm/bro/extracted/%s-%s.%s.%s", f$source, f$id, ext, f$info$filename);
    Files::add_analyzer(f, Files::ANALYZER_EXTRACT, [$extract_filename=fname]);
    }

<% end %>
